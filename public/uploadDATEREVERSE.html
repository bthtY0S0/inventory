<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>SmartInventory</title>
  <style>
    body { font-family: sans-serif; padding: 2rem; background: #f4f4f4; }
    button { padding: 1rem 1.5rem; font-size: 1rem; background: #007bff; color: white; border: none; cursor: pointer; border-radius: 4px; margin-right: 1rem; }
    button:hover { background: #0056b3; }
    label { margin-right: 1rem; }
    #result { margin-top: 2rem; }
    table { width: 100%; border-collapse: collapse; margin-top: 1rem; background: white; }
    th, td { padding: 0.75rem; text-align: left; border: 1px solid #ccc; }
    th { background: #eee; }
    tr.updated { background-color: #e1fbe1; }
    tr.skipped { background-color: #fff7d6; }
    .section-title { margin-top: 2rem; font-weight: bold; font-size: 1.1rem; }
    .message { margin-top: 1rem; padding: 1rem; background: #fff; border: 1px solid #ccc; white-space: pre-wrap; }
    .status-ok { color: green; font-weight: bold; }
    .status-warning { color: orange; font-weight: bold; }
    .status-danger { color: red; font-weight: bold; }
  </style>
</head>
<body>

  <h1>SmartInventory</h1>

  <input type="file" id="fileInput" accept=".csv" style="display: none;" />
  <button id="uploadBtn">Upload CSV</button>
  <button id="downloadBtn">Download Inventory CSV</button>

  <div class="section-title">üîß Manual Adjustment</div>
  <form id="manualForm">
    <label>SKU: <input type="text" id="manualSku" required /></label>
    <label>Logo: <input type="text" id="manualLogo" required /></label>
    <label>Quantity (+/-): <input type="number" id="manualQty" required /></label>
    <button type="submit">Submit</button>
  </form>

  <div id="result"></div>

  <script>
    const fileInput = document.getElementById('fileInput');
    const uploadBtn = document.getElementById('uploadBtn');
    const resultDiv = document.getElementById('result');

    uploadBtn.addEventListener('click', () => fileInput.click());

    fileInput.addEventListener('change', async () => {
      const file = fileInput.files[0];
      if (!file) return;

      const formData = new FormData();
      formData.append('file', file);
      resultDiv.innerHTML = '<div class="message">Uploading...</div>';

      try {
        const uploadRes = await fetch('/api/receipts/upload', { method: 'POST', body: formData });
        const data = await uploadRes.json();
        resultDiv.innerHTML = `<div class="message">‚úÖ ${data.message}</div>`;
        displayReport();

        // Download CSV with date
        const csvRes = await fetch('/api/inventory/export-csv');
        const blob = await csvRes.blob();
        const url = window.URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        const today = new Date().toISOString().split('T')[0];
        link.download = `SmartInventory_${today}.csv`;
        document.body.appendChild(link);
        link.click();
        link.remove();
        window.URL.revokeObjectURL(url);

      } catch (err) {
        resultDiv.innerHTML = '<div class="message">‚ùå Upload failed.</div>';
      }
    });

    document.getElementById('downloadBtn').addEventListener('click', async () => {
      const csvRes = await fetch('/api/inventory/export-csv');
      const blob = await csvRes.blob();
      const url = window.URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      const today = new Date().toISOString().split('T')[0];
      link.download = `SmartInventory_${today}.csv`;
      document.body.appendChild(link);
      link.click();
      link.remove();
      window.URL.revokeObjectURL(url);
      displayReport();
    });

    async function displayReport() {
      resultDiv.innerHTML += '<div class="message">Loading report...</div>';
      const res = await fetch('/api/inventory/report');
      const { items } = await res.json();
      const table = document.createElement('table');
      table.innerHTML = `<tr><th>#</th><th>Name</th><th>Logo</th><th>SKU</th><th>Qty</th><th>Status</th></tr>`;
      items.forEach((item, i) => {
        const tr = document.createElement('tr');
        let statusText = '', statusClass = '';
        if (item.quantity <= 25) {
          statusText = 'üî¥ Reorder Now'; statusClass = 'status-danger';
        } else if (item.quantity <= 30) {
          statusText = 'üü† Low Stock'; statusClass = 'status-warning';
        } else {
          statusText = 'üü¢ OK'; statusClass = 'status-ok';
        }
        tr.className = 'updated';
        tr.innerHTML = `<td>${i + 1}</td><td>${item.name}</td><td>${item.logo}</td><td>${item.sku}</td><td>${item.quantity}</td><td class="${statusClass}">${statusText}</td>`;
        table.appendChild(tr);
      });
      resultDiv.appendChild(table);
    }

    document.getElementById('manualForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const sku = document.getElementById('manualSku').value.trim();
      const logo = document.getElementById('manualLogo').value.trim();
      const quantity = parseInt(document.getElementById('manualQty').value);

      if (!sku || !logo || isNaN(quantity)) {
        resultDiv.innerHTML = '<div class="message">‚ùå Invalid manual entry.</div>';
        return;
      }

      try {
        const res = await fetch('/api/inventory/adjust', {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ sku, logo, quantity })
        });

        const data = await res.json();
        if (!res.ok) {
          resultDiv.innerHTML = `<div class="message">‚ö†Ô∏è ${data.message}</div>`;
        } else {
          resultDiv.innerHTML = `<div class="message">‚úÖ ${data.message}\n${data.updatedItem.name} (${data.updatedItem.logo}) now has ${data.updatedItem.newQty} units.</div>`;
          displayReport();
        }
      } catch (err) {
        resultDiv.innerHTML = '<div class="message">‚ùå Request failed.</div>';
      }
    });
  </script>

</body>
</html>

